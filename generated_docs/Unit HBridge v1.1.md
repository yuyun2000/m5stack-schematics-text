# Unit HBridge v1.1 原理图描述

---

## 原理图分析

好的，这是基于您提供的原理图信息和提示词生成的 M5Stack Unit HBridge v1.1 技术描述。

---

### **M5Stack Unit HBridge v1.1 原理图描述**

#### **1. 主要芯片及其功能**

*   **微控制器 (MCU):** STM32F030F4P6。作为模块的控制核心，负责处理来自 M5 主机的 I2C 通信、解析指令，并生成控制电机驱动芯片所需的 PWM 信号。同时，它还负责读取电流检测芯片的模拟信号，并控制总电源 MOS 管的开关。
*   **H桥驱动芯片:** RZ7899。这是一款双向直流电机驱动芯片，接收来自 STM32 的逻辑电平控制信号，并为电机提供足够的驱动电流和电压。它实现了电机的正转、反转和制动功能。
*   **电流检测放大器:** INA199A1DCKR。该芯片用于高侧电流检测，它测量流经电机总回路的电流，并输出一个与电流大小成正比的模拟电压信号，供 STM32 的 ADC 通道采集。

#### **2. 电路设计思想**

该模块采用主从式架构设计。STM32F030 作为从设备，通过 I2C 接口与 M5 主机（主设备）通信。它将底层的电机 PWM 控制、电流监控和电源管理等复杂操作封装起来，为主机提供了一个简洁的控制接口。主机仅需发送高级指令（如设定转速、方向、制动），即可实现对直流电机的精确控制和状态监控。电路集成了灵活的电源选择、完善的保护机制和精确的电流反馈，构成了一个功能完整的智能电机驱动单元。

#### **3. 供电与电源管理**

*   **主电源输入:** 通过一个 VH3.96-4P 接口（VIN）接收外部 6V 至 12V 的直流电源。输入端并联了一颗 470uF 的铝电解电容，用于稳定输入电压、吸收浪涌。
*   **DC/DC 降压电路:** 外部输入的 6V-12V 电压（VIN）经过一个板载 DC/DC 降压（Buck）转换器电路，生成一个稳定的 5V 电压，作为电机供电的选项之一。
*   **电机电源选择:** 板载一个电源切换开关（SW1）。该开关用于选择 H 桥驱动芯片 RZ7899 的工作电源。用户可以选择使用外部直接输入的 6V-12V 电压，或选择使用内部 DC/DC 降压后生成的 5V 电压来驱动电机。
*   **逻辑电路供电:** 模块通过 HY2.0-4P (Grove) 接口从 M5 主机获取 5V 电源。该 5V 电源通过一颗 LDO（低压差线性稳压器）转换为 3.3V，专门为 STM32F030 微控制器及其他数字逻辑电路供电。
*   **总电源控制与保护:** 在电机供电路径上，串联了一个 P-Channel MOSFET 作为总电源开关。该 MOS 管的栅极由 STM32 的一个 GPIO 引脚（标记为 EN）控制。通过控制此 GPIO，可以实现对电机供电的完全切断或接通，起到电机锁定/释放和紧急停机的作用。

#### **4. 信号路径与电路连接关系**

*   **I2C 通信路径:**
    *   M5 主机通过 HY2.0-4P Grove 接口的 SDA 和 SCL 线与模块连接。
    *   SDA 和 SCL 信号线连接到 STM32F030 的 I2C 引脚（PB7 和 PB6）。
    *   模块上设有一个拨码开关，连接到 STM32 的 GPIO 引脚（如 PA0, PA1），通过读取这些引脚的电平状态来修改 I2C 从机地址，默认地址为 0x20。

*   **电机驱动信号路径:**
    *   STM32F030 的两个定时器 PWM 输出引脚（如 PA8, PA11）分别连接到 RZ7899 驱动芯片的输入引脚 IN1 和 IN2。
    *   STM32 通过改变这两个引脚上输出的 PWM 信号的占空比和逻辑电平组合，来控制电机的转速和方向。
        *   **正/反转:** 一个引脚输出 PWM 信号，另一个引脚保持低电平。
        *   **制动:** 两个引脚同时输出高电平。
    *   RZ7899 的输出引脚 OUT1 和 OUT2 连接到电机接线端子，直接驱动电机负载。

*   **电流检测反馈路径:**
    *   在电机主供电回路中，串联一个低阻值的采样电阻。
    *   INA199A1DCKR 芯片的输入端跨接在该采样电阻两端，以检测其上的电压降。
    *   INA199A1DCKR 的输出引脚（OUT）产生一个经过放大的模拟电压信号，该信号连接到 STM32F030 的一个 ADC 输入引脚（如 PA4）。
    *   STM32 通过其内置的 ADC 转换器，将此模拟电压转换为数字值，从而计算出当前的总电机电流，用于实现过流保护或数据上报。

*   **使能控制逻辑:**
    *   STM32F030 的一个 GPIO 引脚（EN）用于控制总电源 P-Channel MOSFET 的栅极。当此引脚输出低电平时，MOS 管导通，电机回路得电；当输出高电平时，MOS 管关断，切断电机电源。

---

## 补充信息

好的，基于您提供的原理图信息，以下是对前述描述的补充和细化：

### **补充描述**

#### **5. 接口与连接器总结**

*   **电源输入接口:** 1x VH3.96-4P 接口，用于接入 6V-12V 的外部直流电源。
*   **通信与逻辑供电接口:** 1x HY2.0-4P (Grove) 接口，连接至 M5 主机。它为模块的 STM32F030 和逻辑电路提供 5V 供电，并传输 I2C 通信信号（SDA/SCL）。
*   **电机输出接口:** 1x 两针接线端子，用于连接直流电机的两极。

#### **6. 驱动控制逻辑**

STM32F030 对 RZ7899 驱动芯片的控制逻辑如下表所示，通过控制 IN1 和 IN2 引脚的电平状态实现对电机行为的精确管理：

| IN1 (连接STM32引脚) | IN2 (连接STM32引脚) | 电机状态 | 描述 |
| :--- | :--- | :--- | :--- |
| PWM | L (低电平) | 正转 | 电机以 PWM 占空比决定的速度正向旋转。 |
| L (低电平) | PWM | 反转 | 电机以 PWM 占空比决定的速度反向旋转。 |
| H (高电平) | H (高电平) | 制动 (Brake) | 电机输出端短路，产生反向电动势，使电机快速停止。 |
| L (低电平) | L (低电平) | 滑行/空闲 (Coast) | 电机输出端呈高阻态，电机在无驱动力的情况下自由滑行停止。 |

#### **7. 保护机制详解**

模块集成了多重保护机制以确保安全稳定运行：

*   **软件过流保护:** 电流检测芯片 INA199A1DCKR 将实时电流数据反馈给 STM32。STM32 的固件内部设定了一个电流阈值（例如 3A）。当监测到的电流超过该阈值时，STM32 会主动执行保护程序，例如立即停止 PWM 输出并进入制动状态，或通过控制总电源 MOS 管（EN引脚）直接切断电机供电。
*   **硬件过热保护 (TSD):** 此功能集成在 RZ7899 驱动芯片内部。当芯片温度超过其内部设定的安全上限时，芯片会自动关闭输出级，防止因过热导致永久性损坏。当温度降回安全范围后，芯片通常会自动恢复工作。
*   **硬件欠压锁定 (UVLO):** 此功能同样集成在 RZ7899 芯片内部。如果供给电机的电压（VIN 或 5V）低于芯片正常工作所需的最低电压，芯片将保持关闭状态，防止在不稳定的低电压下误操作或损坏电机。

#### **8. 关键性能参数**

*   **最大负载电流:** 该模块设计的最大持续工作电流为 **3A**。过流保护机制的阈值通常会围绕此参数进行设置。

---

*该文档由 AI 自动生成，生成时间: 2025-11-18 00:50:31*
