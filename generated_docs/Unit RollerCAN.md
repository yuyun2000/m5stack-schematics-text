# Unit RollerCAN 原理图描述

---

## 原理图分析

好的，这是根据您提供的原理图信息和提示词生成的 Unit RollerCAN 原理图结构化描述。

***

### 1. 主要芯片及其功能

*   **微控制器 (MCU):** `STM32G431CBU6` (UFQFPN48 封装)。作为整个系统的控制核心，该芯片基于 ARM Cortex-M4 内核，负责运行磁场定向控制 (FOC) 算法，处理传感器数据，控制电机驱动器，并管理所有外设，包括显示屏、RGB LED、通讯接口及用户输入。
*   **三相无刷电机驱动器:** `DRV8311HRRWR` (VQFN 32 封装)。该芯片是一个集成的三相无刷直流电机驱动器，内置功率 MOSFETs。它接收来自 MCU 的 PWM 信号，直接驱动电机三相绕组。芯片内部集成了电流检测放大器和保护功能（如过流、过温、欠压保护），并将故障状态通过 `nFAULT` 引脚反馈给 MCU。
*   **磁编码角度传感器:** `TLI5012BE1000`。这是一款高精度绝对位置角度传感器，通过 SPI 接口与 MCU 连接，实时提供电机转子的精确角度位置信息（分辨率 36000 位置/360°）。该反馈是实现 FOC 闭环控制（位置环、速度环、电流环）的关键。

### 2. 电路设计思想

该设计以 `STM32G431CBU6` 为中心，构建了一个完整的 FOC 闭环电机控制系统。系统通过 `DRV8311` 驱动无刷电机，同时由 `TLI5012B` 传感器提供高精度转子位置反馈。通过 CAN 总线和 I2C 接口实现与外部系统的数据交互和控制。集电环（电滑环）的设计允许设备在 360° 连续旋转的同时，保持顶部外设的供电和 I2C 通信不中断。

### 3. 供电与充电电路

*   **双路电源输入:**
    1.  **电机驱动电源 (VM):** 通过 `XT30 (2+2)` 接口输入 6V–16V DC。此电源直接供给 `DRV8311` 电机驱动芯片，作为驱动电机的主电源。
    2.  **逻辑与外设电源:** 通过 `Grove (HY2.0-4P)` 接口输入 5V DC。此电源用于为 MCU 和其他低压逻辑电路供电。
*   **电源转换与稳压:**
    *   板载一个 DC-DC 降压转换器，将来自 `XT30` 接口的 6V–16V 输入电压转换为稳定的 5V (`V_LOGIC`)。该 5V 电源为 `STM32G431` MCU、OLED 屏幕、RGB LED 和 `TLI5012B` 传感器等逻辑部分供电。
    *   驱动电源 (VM) 和逻辑电源 (`V_LOGIC`) 相互独立，确保逻辑电路的稳定性不受电机大电流波动的影响。
*   **电源输出:** 位于顶部的 Grove 接口通过集电环从主板获得 5V 电源，可对外提供最大 300mA 的电流。

### 4. 信号路径与电路连接关系

*   **MCU 与电机驱动器 (`DRV8311`):**
    *   MCU 通过三对 PWM 信号控制 `DRV8311` 的三相半桥。
    *   `DRV8311` 的电流采样输出引脚连接到 `STM32G431` 的 ADC 输入引脚，用于 FOC 的电流环控制。
    *   `DRV8311` 的 `nFAULT` 引脚连接到 MCU 的一个 GPIO，用于上报驱动器故障。
    *   `DRV8311` 的使能引脚由 MCU 的一个 GPIO 控制。
*   **MCU 与角度传感器 (`TLI5012B`):**
    *   通过 SPI 总线连接，MCU 作为主机，传感器作为从机，实现高速、实时的角度数据读取。
*   **MCU 与外设:**
    *   **OLED 屏幕:** 通过 SPI 总线连接。`PB15 (MOSI)`、`PB13 (SCK)`、`PB14 (DC)`、`PB10 (RST)`、`PB12 (CS)` 分别对应屏幕的数据、时钟、数据/命令选择、复位和片选信号。
    *   **RGB LED (`WS2812-2020`):** 两颗 LED 以菊花链形式串联，其数据输入端连接到 MCU 的 `PB5 (LED_DAT)` 引脚。
    *   **按键:** 功能按键 `SYS_SW` 连接到 MCU 的 `PC6` 引脚，用于用户输入。

### 5. 外设模块与逻辑电路

*   **显示模块:** 一个 0.66 英寸、64×48 分辨率的 SPI 接口 OLED 屏幕，用于显示设备状态、电机参数或故障代码。
*   **状态指示:** 两颗 `WS2812-2020` RGB LED，可通过编程显示任意颜色，用于指示系统状态，如正常运行、故障、CAN 通信等。
*   **电压过载检测:** 主电源输入端设有一个分压电路，连接到 MCU 的一个 ADC 引脚。MCU 固件通过持续监测该引脚电压，判断输入电压是否超过 18V。若超过，则触发故障逻辑，屏幕显示错误代码 `E:1`，同时控制 RGB LED 亮起蓝色。

### 6. 串口与通讯芯片

*   **CAN 总线:**
    *   `STM32G431` 的 `PA11 (FDCAN_RX)` 和 `PA12 (FDCAN_TX)` 引脚连接到一个 CAN 收发器芯片。
    *   CAN 收发器的 CANH 和 CANL 信号线连接到 `XT30 (2+2)` 接口的通讯引脚。
    *   MCU 的 `PB4` 引脚连接到 CAN 收发器的待机 (`STB`) 引脚，用于控制收发器进入低功耗模式。
*   **I2C 总线:**
    *   MCU 的 `PA15 (SCL)` 和 `PB7 (SDA)` 引脚作为 I2C 主机接口。
    *   这些信号线连接到底部的 Grove 接口 (`GND, 5V, SDA, SCL`)，并穿过集电环连接到顶部的 Grove 接口，允许与外部 I2C 设备通信。
    *   该 I2C 总线地址为 `0x64`。

### 7. 集电环结构

*   设备包含一个集电环（电滑环）结构，电气上连接了设备底部主板上的 Grove 接口与顶部旋转部件上的 Grove 接口。
*   集电环传输四条线路：`GND`、`5V`、`SDA` 和 `SCL`。
*   此设计确保了当电机带动顶部结构 360° 旋转时，顶部 Grove 接口的电源供应和 I2C 数据通信能够持续进行，不受线缆缠绕的限制。

### 8. 调试接口

*   原理图上引出了标准的 SWD/SWO 调试接口，包括 `SWDIO`、`SWCLK`、`SWO`、`NRST` 以及电源引脚，用于对 `STM32G431CBU6` 进行固件烧录和在线调试。

---

## 补充信息

好的，基于先前的描述，以下是对 Unit RollerCAN 原理图在设计细节和实现层面的补充说明：

### 补充说明

#### 1. 电源保护与滤波电路

*   **输入保护:** 在 `XT30` 的 6V–16V DC 输入端，通常会设计有反接保护电路（如使用一个 P-MOSFET 或一个二极管）和瞬态电压抑制 (TVS) 二极管，以防止电源反接和电压尖峰对后级电路造成损害。
*   **电源去耦:**
    *   **电机驱动电源 (VM):** 在 `DRV8311` 芯片的 VM 输入引脚附近，会放置一个或多个大容量电解电容（如 100µF 或更高）作为储能和滤波，用于吸收电机启动和换向时产生的大电流冲击。同时，还会并联小容量的陶瓷电容（如 0.1µF）用于高频去耦。
    *   **逻辑电源 (5V / 3.3V):** 在 `STM32G431` MCU、`TLI5012B` 传感器以及其他逻辑芯片的 VDD 引脚旁，均会放置 0.1µF 或 1µF 的陶瓷电容进行就近去耦，以确保电源的稳定，防止高频噪声干扰。

#### 2. 电机驱动细节与电流采样

*   **电流采样电路:** `DRV8311` 通过在三相半桥的低边（Low-Side）路径上串联低阻值、高精度的采样电阻（Shunt Resistor）来实现相电流的检测。采样电阻两端的压降信号会被 `DRV8311` 内部的运算放大器放大，然后输出给 `STM32G431` 的 ADC 引脚。MCU 通过对这些 ADC 值进行采样，重建三相电流，从而实现 FOC 算法中的电流环闭环控制。
*   **自举电路:** `DRV8311` 内部集成了自举（Bootstrap）电路，用于驱动高边（High-Side）的 N-MOSFET。原理图中会体现连接在 `CPH`、`CPL` 和对应相输出（`SHx`）引脚之间的自举电容，这是驱动器正常工作所必需的。

#### 3. 总线物理层实现

*   **CAN 总线端接:** 在 CAN 总线的物理层，为了保证信号质量和抑制反射，通常会在总线的两个末端各并联一个 120Ω 的终端电阻。在该模块上，可能会通过跳线或拨码开关来选择是否启用板载的 120Ω 终端电阻，以适应其在总线网络中的不同位置（末端或中间节点）。
*   **I2C 总线上拉:** I2C 的 `SDA` 和 `SCL` 信号线均为开漏输出，因此在总线上必须连接上拉电阻到 `VCC`（此例中为 5V）。原理图中会体现这两个上拉电阻（典型值为 2.2kΩ 至 10kΩ），它们是 I2C 通信正常工作的必要条件。

#### 4. MCU 外设资源分配总结

为了实现上述功能，`STM32G431CBU6` 的片上外设资源被高效利用：

*   **FDCAN:** 用于实现 CAN FD 通信协议。
*   **TIM (高级/通用定时器):** 用于生成三相互补 PWM 信号以控制 `DRV8311`，并可能用于 `WS2812` LED 的时序生成。
*   **ADC:** 用于采集 `DRV8311` 输出的相电流信号以及监测输入电源电压。
*   **SPI:** 两路 SPI 接口被分别用于与 `OLED` 屏幕和 `TLI5012B` 角度传感器进行高速数据通信。
*   **I2C:** 用于通过 Grove 接口与外部 I2C 从设备通信。
*   **GPIO:** 用于控制 `DRV8311` 的使能/复位、CAN 收发器的待机模式、OLED 的控制信号以及读取按键状态。

这些补充内容共同构成了 Unit RollerCAN 硬件设计的完整技术视图。

---

*该文档由 AI 自动生成，生成时间: 2025-11-18 03:00:23*
