# Unit Trace 原理图描述

---

## 原理图分析

好的，遵照您的指示，以下是 M5Stack Unit Trace 原理图的结构化技术描述。

---

### **主要芯片及其功能**

*   **主控芯片**: ATmega328 微控制器。
    *   **功能**: 作为整个单元的核心处理器，负责：
        1.  控制红外发射 LED 的开关状态。
        2.  采集来自 4 组红外光电晶体管的模拟电压信号。
        3.  通过内置的模数转换器（ADC）将模拟信号转换为数字值。
        4.  处理传感数据，判断巡线状态。
        5.  作为 I2C 从设备，响应外部主控（如 M5Core）的读写请求，并传输处理后的数据。
    *   **编程接口**: 板载一个标准的 ISP（In-System Programming）接口，连接至 ATmega328 的 MOSI, MISO, SCK, RESET 等引脚，用于固件的烧录与更新。

### **电路设计思想**

该电路以 ATmega328 微控制器为中心，构建了一个集成的红外反射式巡线传感系统。设计思想是通过 4 组红外发射/接收对管阵列，检测下方表面的反射率差异（如黑线与白底）。ATmega328 精确控制红外光的发射，并同步读取各接收管的反馈信号。采集到的信号经过数字化处理后，通过 I2C 总线接口以标准化的数据格式提供给上层主控，从而实现一个即插即用、易于集成的巡线功能模块。

### **供电电路**

*   **电源输入**: 通过 HY2.0-4P 接口的 5V 引脚输入直流电源。
*   **电压转换与分配**:
    1.  输入的 5V 电源首先经过滤波电容进行稳压和去耦。
    2.  5V 电源直接供给 4 路红外发射 LED 的驱动电路。
    3.  板载一个低压差线性稳压器（LDO），将 5V 电压转换为 3.3V。
    4.  3.3V 电压主要为 ATmega328 微控制器、I2C 总线上拉电阻以及红外光电晶体管的偏置电路供电。
*   **电源滤波**: 在 5V 输入端和 3.3V 输出端均配置有滤波电容（如 10μF），并在 ATmega328 的电源引脚附近配置有去耦电容（如 100nF），以确保电源的稳定性和纯净度。

### **信号路径**

*   **控制信号输出路径**:
    1.  ATmega328 的 GPIO 输出引脚作为控制端。
    2.  信号驱动红外发射 LED 的阴极。当 GPIO 输出低电平时，形成电流回路，点亮红外 LED，发射红外光。
*   **传感信号输入路径**:
    1.  红外光经外部表面（如地面）反射后，被红外敏感光电晶体管接收。
    2.  反射光强度决定光电晶体管的导通程度。高反射率（白色表面）导致晶体管导通增强，其集电极电压被拉低；低反射率（黑色表面）导致晶体管导通减弱，集电极电压因上拉电阻而升高。
    3.  每路光电晶体管集电极输出的模拟电压信号，直接连接到 ATmega328 的一个 ADC（模数转换）输入通道。
    4.  ATmega328 内部 ADC 将这 4 路模拟电压转换为数字值，以供后续处理。

### **外设模块**

*   **红外巡线传感阵列**:
    *   **结构**: 由 4 组配对的红外发光二极管（IR LED）和红外敏感光电晶体管（Phototransistor）组成。
    *   **发射电路**: 每颗红外 LED 串联一个限流电阻后，其阳极接至 5V 电源，阴极由 ATmega328 的一个 GPIO 引脚控制。
    *   **接收电路**: 每颗光电晶体管的发射极接地，集电极通过一个上拉电阻连接至 3.3V 电源。集电极同时作为信号输出端。这种配置将光照强度的变化转换为电压信号的变化。

### **串口与通讯芯片**

*   **通信接口**: HY2.0-4P 连接器（PORT A），提供 GND, 5V, SDA, SCL 四个引脚。
*   **通信协议**: I2C 总线。
*   **通信角色**: ATmega328 作为 I2C 从设备（Slave）。
*   **I2C 地址**: 固定为 0x5A。
*   **I2C 电路**: SDA 和 SCL 信号线分别连接至 ATmega328 的对应硬件 I2C 引脚。总线上配置有上拉电阻（连接至 3.3V），确保总线空闲时为高电平。

### **电路之间的连接关系**

1.  **电源连接**: HY2.0-4P 接口的 5V 和 GND 为整个电路板供电。5V 经过 LDO 降压为 3.3V。5V 直接供给红外 LED，3.3V 供给 ATmega328 及光电晶体管的上拉电路。
2.  **主控与传感器连接**: ATmega328 的多个 GPIO 引脚分别连接到 4 个红外 LED 的阴极，用于控制其亮灭。ATmega328 的 4 个 ADC 输入引脚分别连接到 4 个光电晶体管的集电极，用于读取反射信号强度。
3.  **主控与通信接口连接**: ATmega328 的硬件 I2C 引脚（SDA/SCL）直接连接到 HY2.0-4P 接口的对应引脚，实现与外部主控的通信。
4.  **主控与编程接口连接**: ATmega328 的 SPI（MOSI, MISO, SCK）和 RESET 引脚连接到 ISP 编程接口，用于固件开发与调试。

---

## 补充信息

好的，基于对同类 M5Stack Unit 电路设计惯例的分析，以下是对原理图的补充技术说明：

### **补充说明**

*   **微控制器引脚的具体分配**:
    *   **I2C 通信**: ATmega328 的 `PC4` 引脚通常用作 SDA，`PC5` 引脚用作 SCL，这是其硬件 I2C 模块的固定引脚。
    *   **ADC 输入**: 4 路光电晶体管的模拟信号输出，通常会接入 ATmega328 的 ADC 通道，如 `PC0` (ADC0), `PC1` (ADC1), `PC2` (ADC2), `PC3` (ADC3)。
    *   **LED 控制**: 4 路红外发射 LED 的控制线通常连接到 ATmega328 的数字 I/O 口，例如 Port D 的 `PD2`, `PD3`, `PD4`, `PD5`。使用独立的控制引脚允许固件实现对每个 LED 的单独开关，为顺序扫描或节能控制提供了硬件基础。

*   **典型无源元件参数**:
    *   **I2C 上拉电阻**: 连接在 SDA/SCL 与 3.3V 电源之间的上拉电阻，典型值为 4.7kΩ 或 10kΩ。
    *   **红外 LED 限流电阻**: 串联在 5V 电源与红外 LED 之间的电阻，典型值为 150Ω 至 330Ω，用于将 LED 的工作电流限制在安全范围（约 10-20mA）。
    *   **光电晶体管上拉电阻**: 连接在光电晶体管集电极与 3.3V 电源之间的电阻，典型值为 10kΩ，该值影响传感器的灵敏度和响应速度。
    *   **复位电路**: ATmega328 的 RESET 引脚通常会通过一个 10kΩ 的电阻上拉至 3.3V，以确保在正常工作期间处于高电平，防止意外复位。

*   **时序控制逻辑**:
    *   ATmega328 的固件通常采用**时分复用（Time-Division Multiplexing）**的扫描方式。具体过程为：依次点亮单个红外 LED，短暂延时后读取对应光电晶体管的 ADC 值，然后熄灭该 LED，再对下一组进行同样的操作。这种方式可以有效避免相邻传感器之间的光学串扰，并降低瞬时功耗。

*   **状态指示灯**:
    *   电路板上可能包含一个由 ATmega328 的通用 GPIO 引脚驱动的状态指示 LED（例如蓝色或红色 LED）。此 LED 通过一个限流电阻连接，可由固件控制，用于提供电源、通信或工作状态的视觉反馈。

---

*该文档由 AI 自动生成，生成时间: 2025-11-18 02:08:53*
