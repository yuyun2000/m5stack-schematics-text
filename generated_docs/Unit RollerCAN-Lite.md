# Unit RollerCAN-Lite 原理图描述

---

## 原理图分析

好的，这是对 M5Stack Unit RollerCAN-Lite 原理图的结构化技术描述。

### **主要芯片及其功能**
*   **STM32G431CBU6**：主控制单元（MCU）。该芯片基于 ARM Cortex-M4 内核，负责运行设备的核心固件，包括：
    *   执行磁场定向控制（FOC）算法，处理来自磁编码器的位置反馈和来自驱动器的电流反馈，生成 PWM 信号。
    *   控制 DRV8311 电机驱动芯片的使能与状态监测。
    *   通过 SPI 接口驱动 0.66 英寸 OLED 显示屏，更新状态信息。
    *   通过 FDCAN 外设处理 CAN 总线通讯。
    *   通过 I2C 外设与 Grove 接口设备通讯。
    *   驱动 WS2812 RGB LED 灯效，并监测按键输入。
*   **DRV8311HRRWR**：三相无刷直流电机（BLDC）驱动芯片。它集成了六个功率 MOSFET，构成三个半桥驱动器，直接驱动电机线圈。其功能包括：
    *   接收来自 MCU 的六路 PWM 信号（INHA/INLA, INHB/INLB, INHC/INLC），控制三相输出（OUT_A, OUT_B, OUT_C）的电平状态。
    *   内置低侧电流采样放大器，将流经外部采样电阻的相电流转换为电压信号，并输出至 MCU 的 ADC 引脚用于 FOC 电流环控制。
    *   提供故障诊断输出（nFAULT）和低功耗睡眠模式控制（nSLEEP）。
*   **TLI5012BE1000**：磁性角度编码器。它通过非接触式方式检测电机转子的绝对位置，并将位置数据通过其串行接口（SSC）反馈给 MCU，是实现 FOC 位置环和速度环闭环控制的关键传感器。

### **电路设计思想**
该电路的核心设计思想是构建一个紧凑、集成化的无刷电机伺服驱动单元。以高性能的 STM32G431 MCU 为控制核心，利用其内置的 FOC 相关硬件外设（如高级定时器、ADC）配合外部高性能电机驱动芯片 DRV8311 和高精度磁编码器 TLI5012B，实现精确的闭环电机控制。电路通过双电源输入设计（宽压直流输入和 5V Grove 输入）提高了应用的灵活性。集成的 CAN 和 I2C 通讯接口使其能够方便地融入更复杂的控制网络中。OLED 显示屏、RGB LED 和按键为人机交互和状态指示提供了直观的途径。

### **供电与充电电路**
*   **双路电源输入**：设备支持两种供电方式。
    1.  通过 CAN XT30 连接器输入 6V–16V 的直流电（`V_CAN`）。
    2.  通过 Grove HY2.0-4P 连接器输入 5V 直流电（`V_GROVE`）。
*   **电源选择与保护**：两路输入通过两个并联的肖特基二极管进行“或”逻辑选择。哪个输入电压更高，就由哪一路为系统供电，同时二极管也起到了反接保护作用。二极管的输出汇合为系统主供电轨 `VIN`。
*   **内部电源稳压**：系统主供电轨 `VIN` 连接到一个降压型（Buck）DC-DC 转换器。该转换器将不稳定的 `VIN`（范围可能从约 4.5V 到 16V）高效地降压至稳定的 3.3V，为 MCU（VDD, VDDA）及其他所有逻辑芯片（OLED, TLI5012B, CAN 收发器等）供电。
*   **电机驱动供电**：电机驱动芯片 DRV8311 的功率级电源（PVDD）直接取自 CAN XT30 连接器输入的 6V–16V `V_CAN` 电压，以提供足够大的功率驱动电机。该供电路径独立于 3.3V 逻辑电源。

### **信号路径**
*   **电机控制与反馈路径**：
    1.  **控制路径**：MCU 根据 FOC 算法生成 6 路 PWM 信号，通过 GPIO 输出至 DRV8311 的 INHx/INLx 引脚。
    2.  **驱动路径**：DRV8311 根据 PWM 信号驱动内部功率管，向三相电机输出高功率驱动信号。
    3.  **电流反馈路径**：电机相电流流经低侧的三个采样电阻，电阻上的压降被 DRV8311 内部的运放放大后，通过 SOx 引脚输出至 MCU 的 ADC 引脚，形成电流闭环。
    4.  **位置/速度反馈路径**：TLI5012B 磁编码器检测电机转子位置，通过其串行接口将数据发送至 MCU 的 SPI 外设引脚，形成位置和速度闭环。
*   **通讯信号路径**：
    1.  **CAN**：MCU 的 FDCAN_TX (PA12) 和 FDCAN_RX (PA11) 引脚连接到外部 CAN 收发器。收发器将单端 TTL 信号转换为差分的 CAN_H 和 CAN_L 信号，连接至两个 XT30 连接器。
    2.  **I2C**：MCU 的 I2C 引脚 SDA (PB7) 和 SCL (PA15) 直接连接到 Grove 连接器，并由上拉电阻拉高至 3.3V。

### **外设模块**
*   **OLED 显示模块**：一个 0.66 英寸的 OLED 屏幕，通过 4 线 SPI 协议与 MCU 连接。连接关系如下：
    *   `PB13` -> `SCK` (串行时钟)
    *   `PB15` -> `MOSI` (主出从入数据)
    *   `PB12` -> `CS` (片选)
    *   `PB14` -> `DC` (数据/命令选择)
    *   `PB10` -> `RST` (复位)
*   **RGB LED 模块**：包含两颗 WS2812 型可编程 RGB LED。MCU 的 `PB5` 引脚（`LED_DAT`）作为数据输出引脚，串行驱动这两颗 LED。第一颗 LED 的 DOUT 连接到第二颗的 DIN，形成菊花链结构。
*   **按键模块**：一个物理按键连接到 MCU 的 `PC6` 引脚（`SYS_SW`）。该引脚内部或外部上拉至 3.3V，按键按下时将引脚拉至低电平，构成一个典型的低电平有效输入电路。
*   **调试接口**：提供标准的 SWD/SWO 调试接口，引脚包括 SWDIO, SWCLK, SWO, NRST, 3.3V 和 GND，用于固件烧录与在线调试。

### **逻辑电路**
本电路中没有复杂的独立逻辑门电路。主要的逻辑功能由以下部分实现：
*   **电源OR-ing逻辑**：通过两个肖特基二极管实现，自动选择较高的电源输入，无需额外的逻辑芯片。

### **串口与通讯芯片**
*   **CAN 接口**：物理层由一个外部 CAN 收发器芯片实现，该芯片负责在 MCU 的 FDCAN 控制器（逻辑电平）和物理 CAN 总线（差分电平）之间进行转换。总线上集成了一个 120Ω 的终端电阻，通常可通过跳线或焊接点选择是否接入。接口通过两个并联的 XT30 2+2 引脚连接器引出，方便菊花链式连接。
*   **I2C 接口**：通过 Grove HY2.0-4P 连接器提供，直接由 MCU 的 I2C 引脚（SDA/PB7, SCL/PA15）驱动。总线地址在软件中定义为 0x64。

### **电平转换**
电路中一处需要关注电平兼容性的地方是 I2C 接口。Grove 接口的 VCC 为 5V，而 MCU 的工作电压为 3.3V。此设计中没有使用专用的电平转换芯片，而是利用了 STM32G431 特定 GPIO 引脚（如 PA15 和 PB7）的 "5V Tolerant"（5V 容忍）特性。这意味着这些引脚可以直接连接到由 5V 上拉的 I2C 总线而不会损坏 MCU。I2C 总线上的上拉电阻连接到板载的 3.3V 电源轨。

### **电源管理**
*   **主电源架构**：采用“双路输入 -> 二极管合路 -> Buck降压 -> 3.3V 逻辑供电”的架构。
*   **驱动电源隔离**：电机驱动芯片 DRV8311 的大功率 PVDD 电源（6-16V）与 MCU 和逻辑电路的 3.3V 电源在物理上是分开的，仅通过 Buck 转换器和地线相连，减少了电机噪声对逻辑电路的干扰。
*   **低功耗控制**：MCU 可以通过控制 DRV8311 的 `nSLEEP` 引脚，使其进入低功耗睡眠模式，从而在待机时显著降低电机驱动部分的功耗。

### **电路之间的连接关系**
*   **MCU 中心枢纽**：STM32G431 是所有功能模块的连接中心。
*   **电机控制环路**：MCU 通过 PWM 信号控制 DRV8311，DRV8311 驱动电机；电机电流通过采样电阻和 DRV8311 内部运放反馈至 MCU 的 ADC；电机转子位置由 TLI5012B 编码器检测并通过串行接口反馈至 MCU。这三者共同构成完整的 FOC 闭环控制系统。
*   **人机交互与通讯**：MCU 通过 GPIO 直接控制 RGB LED 和监测按键；通过 SPI 控制 OLED 显示；通过 I2C 和 FDCAN 外设（经收发器）分别与 Grove 接口和 CAN 总线进行数据交换。
*   **电源分配**：外部电源经二极管和 Buck 转换器后，生成 3.3V 电压，分配给 MCU、编码器、OLED、CAN 收发器等所有逻辑器件。而 6-16V 的原始输入电压则直接供给 DRV8311 的功率级。

---

## 补充信息

好的，这是对 M5Stack Unit RollerCAN-Lite 原理图的补充技术细节：

### **补充技术细节**

#### **MCU 系统电路**
*   **时钟源**：为了保证 170MHz 高性能运算和 FDCAN 等外设的精确波特率，MCU 的时钟系统采用了外部高速晶体振荡器（HSE）。一个外部晶体连接在 `OSC_IN` 和 `OSC_OUT` 引脚之间，并配有两个负载电容，为系统提供稳定、精确的主时钟源。
*   **复位电路**：MCU 的 `NRST` 引脚连接了一个标准的上拉电阻和下拉电容组成的 RC 复位电路，确保上电时可靠复位。该引脚也连接到 SWD 调试接口，允许调试器对 MCU 进行硬件复位。
*   **启动模式**：`BOOT0` 引脚通过一个下拉电阻接地。这确保了在正常上电或复位后，MCU 默认从其内部的 Flash 存储器启动，加载并执行用户程序。
*   **电源去耦**：在 MCU 的每个 `VDD` 和 `VDDA` 电源引脚附近，都放置了去耦电容（通常为 100nF）。这些电容为芯片提供了一个低阻抗的瞬时电流源，有效滤除电源噪声，保证了 MCU 在高频工作下的稳定性。

#### **电机驱动电路**
*   **自举电路 (Bootstrap Circuit)**：DRV8311 驱动芯片的每个半桥都配置了自举电路。在 `BST_x` (如 `BST_A`) 和 `SH_x` (如 `SH_A`) 引脚之间连接了一个自举电容。当对应的低侧 MOSFET 导通时，该电容通过内部路径充电；当高侧 MOSFET 需要导通时，该电容上的电压作为浮动电源，为高侧栅极驱动器供电。这是驱动 N-MOSFET 高侧管的必要设计。
*   **功率级大容量电容 (Bulk Capacitance)**：在 DRV8311 的功率输入端 PVDD 和 GND 之间，并联了多个大容量的电解电容或陶瓷电容。这些电容用作储能缓冲，为电机在加速、换向时产生的大电流脉冲提供瞬时能量，并吸收电机产生的反电动势和电源纹波，维持 PVDD 电压的稳定。

#### **接口保护与滤波**
*   **ESD 保护**：在所有对外接口，如 CAN 总线的 `CAN_H` / `CAN_L` 和 Grove 接口的 `SDA` / `SCL` 信号线上，通常会放置瞬态电压抑制（TVS）二极管阵列。这些器件能在静电放电（ESD）等过压事件发生时，将高压能量钳位并泄放到地，从而保护内部敏感的 MCU 和收发器芯片。
*   **CAN 总线终端电阻**：CAN 总线上的 120Ω 终端电阻通常是通过一个焊盘跳线或拨码开关来选择是否接入电路。这使得该单元可以灵活地作为总线的终端节点（接入电阻）或中间节点（断开电阻）使用。

---

*该文档由 AI 自动生成，生成时间: 2025-11-18 02:59:00*
