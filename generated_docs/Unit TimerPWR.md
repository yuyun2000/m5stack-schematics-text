# Unit TimerPWR 原理图描述

---

## 原理图分析

### M5Stack Unit TimerPWR 原理图描述

#### 1. 主要芯片及其功能
- **主控芯片 (U1): STM32G031G8U6**
  - 作为系统的核心控制器，负责所有逻辑控制、定时、用户交互和数据处理。
  - **GPIO 功能分配**：
    - `PA0` (BTN_A), `PA4` (BTN_B): 连接按键，用于用户输入。
    - `PA1` (BOOST_EN): 控制 5V 升压电路的使能。
    - `PB5` (HOLD_EN): 控制系统主电源的自锁，实现开关机功能。
    - `PA8` (BL_EN): 控制 OLED 显示屏的背光使能。
    - `PB4` (CHAG): 读取充电芯片的充电状态。
  - **通信接口**：
    - **I2C1**: 使用 `PB6` (SCL) 和 `PB7` (SDA) 与外部 Grove 接口通信。
    - **I2C2**: 使用 `PA9` (SCL2) 和 `PA10` (SDA2) 与板载电源监测芯片 INA3221 通信。
    - **SPI**: 使用 `PB13` (OLED_SCK), `PB15` (OLED_MOSI), `PB12` (OLED_CS), `PA11` (OLED_DC), `PA12` (OLED_RST) 与 OLED 屏幕通信。
- **电源监测芯片 (U2): INA3221**
  - 三通道电压电流监测芯片，通过 I2C2 接口与主控 STM32 通信。
  - **通道 1**: 通过采样电阻 R7 (10mΩ) 监测 Grove 接口 5V 输出的电流，并直接监测其电压。
  - **通道 2**: 通过采样电阻 R6 (10mΩ) 监测电池 (VBAT) 的输出电流，并直接监测电池电压。
  - **通道 3**: 直接监测 USB Type-C 输入的 VBUS 电压 (VUSB_5V)。
- **充电管理芯片 (U5): LGS4056H**
  - 线性锂电池充电管理芯片，负责对连接的 3.7V 锂电池进行充电。
- **3.3V LDO (U3): XC6206P332MR**
  - 低压差线性稳压器，将电池电压 (VBAT) 降压至 3.3V (VCC_3V3)，为主控 STM32 及其他逻辑电路供电。
- **5V 升压芯片 (U4): TPS61023DRLR**
  - DC-DC 同步升压转换器，将电池电压 (VBAT) 升压至 5V (VCC_5V)，专用于为 Grove 接口供电。

#### 2. 电路设计思想
该电路设计为一个带 RTC 功能的、可编程的电池供电控制器。核心思想是利用 STM32 的低功耗和 RTC 功能实现定时开关机，通过 INA3221 精确监测电池和输出负载的电能信息，并通过 OLED 显示。电路通过一个 P-MOSFET (Q2) 和主控的 GPIO (HOLD_EN) 构成电源自锁开关，实现了按键开机和软件关机功能。同时，集成了独立的充电管理和可控的 5V 升压输出，使其成为一个功能完整的小型电源管理模块。

#### 3. 供电与充电电路
- **电源输入**:
  - **Type-C 接口 (J1)**: 提供 5V 电源 (VUSB_5V)，此路电源仅用于为充电芯片 U5 供电，不直接参与系统其他部分的供电。
  - **电池接口 (J2)**: 一个 1.25mm 间距的 2P 连接器，用于连接 3.7V 聚合物锂电池。电池电压定义为 VBAT。
- **充电电路**:
  - 充电管理芯片 U5 (LGS4056H) 的 `VIN` 引脚连接到 Type-C 的 VUSB_5V。
  - `BAT` 引脚连接到电池 J2。
  - `PROG` 引脚通过电阻 R11 (3kΩ) 接地，设定充电电流约为 400mA。
  - `CHRG` 引脚为开漏输出，用于指示充电状态。在充电时，该引脚被拉低。此信号连接到 LED1 和主控的 `PB4` (CHAG) 引脚。

#### 4. 电源管理
- **电源开关逻辑**:
  - 按键 `BTN_A` 通过二极管 D2 连接到 P-MOSFET Q2 的栅极。按下 `BTN_A` 时，Q2 栅极被拉低，Q2 导通，电池电压 VBAT 通过 Q2 为 LDO U3 供电。
  - LDO U3 输出 3.3V (VCC_3V3) 为主控 STM32 供电。
  - STM32 启动后，必须立即将 `PB5` (HOLD_EN) 引脚置为高电平，通过 N-MOSFET Q1 将 Q2 的栅极持续拉低，从而保持 Q2 导通，实现电源自锁。
  - 当 STM32 将 `HOLD_EN` 置为低电平时，Q1 截止，Q2 的栅极被 R8 上拉至 VBAT，Q2 截止，系统断电。
- **系统供电**:
  - **3.3V 电源 (VCC_3V3)**: 由 LDO U3 从 VBAT (经过 Q2 开关后) 转换而来，为 STM32、INA3221、OLED 的逻辑部分以及 I2C 上拉电阻供电。
  - **5V 电源 (VCC_5V)**: 由升压芯片 U4 从 VBAT 转换而来。U4 的使能引脚 `EN` 由主控的 `PA1` (BOOST_EN) 控制，允许软件按需开启或关闭 5V 输出。此 5V 电源专供 Grove 接口。

#### 5. 信号路径
- **按键信号**: `BTN_A` 和 `BTN_B` 分别连接到 STM32 的 `PA0` 和 `PA4` 引脚。按键按下时，相应引脚被拉至低电平。R4 和 R5 为上拉电阻。
- **OLED 显示信号**: STM32 通过 SPI 总线 (`PB13`, `PB15`) 和控制线 (`PA11`, `PA12`, `PB12`) 将图像数据和命令发送到 FPC_CON10 连接器，驱动 OLED 屏幕。背光使能信号 `BL_EN` (`PA8`) 控制屏幕的开启与关闭。
- **I2C 通信路径**:
  - STM32 的 I2C1 (`PB6`, `PB7`) 连接到 Grove 接口 J3，用于与外部 I2C 设备通信。
  - STM32 的 I2C2 (`PA9`, `PA10`) 连接到电源监测芯片 U2 (INA3221)，用于读取内部电源数据。
- **电源监测信号**: U2 (INA3221) 的三个通道分别连接到 `VUSB_5V`、`VBAT` 和 `VCC_5V` 的关键节点，通过内部 ADC 测量后，经由 I2C2 总线将数据传输给 STM32。

#### 6. 外设模块与接口
- **显示模块**: 通过一个 10-pin FPC 连接器 (FPC_CON10) 连接一个 0.66 英寸的 SPI 接口 OLED 显示屏。
- **交互模块**: 两个侧面按键 `BTN_A` 和 `BTN_B`，用于用户配置和操作。
- **通讯接口**: 一个 Grove 标准的 HY2.0-4P 接口 (J3)，提供 GND、VCC_5V、SDA (I2C1) 和 SCL (I2C1) 四个引脚。

#### 7. 逻辑电路与电平转换
- **电源控制逻辑**: 核心是 P-MOSFET Q2 构成的电源主开关，由 `BTN_A` 瞬时触发开机，由 STM32 的 `HOLD_EN` 信号通过 N-MOSFET Q1 实现自锁和软件关机。
- **电平转换**: 电路中未设计专用的电平转换芯片。Grove 接口的 I2C 信号 (`SDA`, `SCL`) 通过上拉电阻 R2 和 R3 (4.7kΩ) 上拉至 `VCC_3V3` (3.3V)，因此 Grove 接口的 I2C 通信逻辑电平为 3.3V。

#### 8. 电路之间的连接关系
- **供电链路**: 电池 (J2) / Type-C (J1) -> 充电芯片 (U5)。电池 (J2) -> 电源开关 (Q2) -> 3.3V LDO (U3) -> STM32 (U1)。电池 (J2) -> 5V 升压电路 (U4) -> Grove 接口 (J3)。
- **控制链路**: STM32 (U1) 通过 `HOLD_EN` 控制电源开关 (Q2)，通过 `BOOST_EN` 控制 5V 升压电路 (U4)。用户通过按键 (`BTN_A`, `BTN_B`) 与 STM32 交互。
- **数据链路**: STM32 (U1) 通过 I2C2 与 INA3221 (U2) 通信获取电源信息，通过 I2C1 与 Grove 接口 (J3) 上的外部设备通信，通过 SPI 与 OLED 显示屏通信。充电芯片 (U5) 通过 `CHAG` 信号向 STM32 (U1) 和 LED1 报告充电状态。

---

## 补充信息

好的，以下是基于原理图可观察到的额外技术细节补充：

### 补充技术细节

#### 1. 硬件保护与稳定性设计
- **ESD 保护**: Type-C 接口 (J1) 处配置了一个 ESD 保护器件 U6，用于保护 VBUS、CC1、CC2、D+ 和 D- 引脚免受静电放电损害，增强了产品的可靠性。
- **电源去耦**: 电路中大量使用了去耦电容（如 C1-C4, C6, C8, C10-C20 等），分布在各个芯片的电源引脚附近以及主电源轨（VBAT, VCC_3V3, VCC_5V）上。这些电容用于滤除电源噪声，为芯片提供稳定、纯净的供电，确保系统运行的稳定性。
- **电源路径隔离**: 开机电路中，二极管 D2 (1N4148W) 的作用是隔离。当用户按下 `BTN_A` 手动开机时，它允许信号导通 P-MOSFET Q2；当系统通过 `HOLD_EN` 信号自锁后，D2 可以防止自锁电路的低电平信号反向影响到 STM32 的 `PA0` 输入引脚。

#### 2. 核心电路实现细节
- **5V 升压电路反馈网络**: 升压芯片 U4 (TPS61023) 的输出电压由其 `FB` 引脚上的分压反馈网络（R9 和 R10）决定。这两个电阻的阻值精确地设定了 VCC_5V 的输出电压为 5V。
- **硬件电源指示**: 电路中包含一个电源指示 LED (LED2，绿色)，该 LED 直接连接在 P-MOSFET Q2 的输出端。因此，只要电源主开关 Q2 导通，该 LED 就会点亮，提供一个独立于软件控制的、直观的硬件上电指示。
- **微控制器启动配置与调试**:
    - **启动模式**: STM32 的 `BOOT0` 引脚通过电阻 R12 (10kΩ) 下拉至地。这确保了在没有外部干预的情况下，微控制器默认从内部主闪存 (Main Flash memory) 启动。
    - **调试接口**: 电路板上预留了 `SWDIO` (TP1) 和 `SWCLK` (TP2) 两个测试点，它们是 STM32 的串行线调试 (SWD) 接口，用于固件的烧录和在线调试。
    - **复位电路**: 微控制器的 `NRST` 引脚连接了一个由 R1 和 C8 组成的标准 RC 复位电路，确保上电时能可靠复位。

#### 3. 接口与功能说明
- **Type-C 功能**: Type-C 接口的 D+ 和 D- 数据线虽然经过了 ESD 保护，但并未连接到主控 STM32。这明确了该接口在此设计中仅用作充电电源输入，不具备 USB 数据通信功能。
- **I2C 地址**: 原理图标明 Grove 接口的 I2C 地址为 0x56，这是该设备作为 I2C 从机时对外呈现的地址。

---

*该文档由 AI 自动生成，生成时间: 2025-11-18 03:04:31*
