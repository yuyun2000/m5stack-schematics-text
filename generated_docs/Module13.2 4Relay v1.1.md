# Module13.2 4Relay v1.1 原理图描述

---

## 原理图分析

好的，这是根据您提供的原理图和提示词生成的 M5Stack Module13.2 4Relay v1.1 模块原理图技术描述。

***

### 1. 主要芯片及其功能
- **微控制器 (MCU)**：核心控制器为 **STM32G030F6**（或 STM32F030F4P6）。它作为 I2C 从设备，负责接收来自 M5 主机的控制指令，并根据指令驱动四路继电器的开关动作。同时，它也负责监测外部输入电源的电压。

### 2. 电源系统
#### 2.1 电源输入与转换
- **外部电源输入**：通过一个 DC-5521 (DC005) 接口输入外部直流电源，电压范围支持 **5V-24V DC**，接口规格为内正外负。该输入电压在原理图中被标记为 **VIN**。
- **DC-DC 降压电路**：板载一个 DC-DC 降压（Buck）转换器。该转换器将输入的 5V-24V `VIN` 电压转换为稳定的 **5V** 电压。
- **电源分配**：
    - 转换后生成的 5V 电压主要为四路继电器的线圈（`RL_5V`）供电。
    - 该 5V 电压也通过 M5-Bus 接口的 **5V** 引脚，为主机或其他堆叠模块供电。
    - `VIN` 电压直接连接到 M5-Bus 的 **HPWR** 引脚，允许其他模块直接使用未经转换的外部电源。

#### 2.2 电压检测电路
- 模块包含一个分压电路，由两个电阻串联组成。该电路的输入端连接到 `VIN`，分压后的节点连接到 MCU 的一个 **ADC (模数转换)** 引脚。此设计使得 MCU 能够实时测量外部输入电源 `VIN` 的电压值。

#### 2.3 MCU 供电
- MCU 及其外围逻辑电路需要 3.3V 供电。板载一个 **LDO (低压差线性稳压器)**，将 DC-DC 输出的 5V 电压进一步降压至 **3.3V (`VCC_3V3`)**，专门供给 STM32 MCU。MCU 的 VDD 引脚旁配有去耦电容以保证电源稳定。

### 3. 继电器及驱动电路
#### 3.1 继电器单元
- 板载四路 **HK4100F-DC5V-SHG** 机械式继电器（K1, K2, K3, K4），其线圈额定工作电压为 5V。
- 每个继电器提供一组常开（**NO** - Normally Open）和公共（**COM** - Common）触点，通过绿色接线端子引出。

#### 3.2 驱动电路
- MCU 的 GPIO 引脚输出的低电流信号无法直接驱动继电器线圈。因此，每个继电器通道都配备了独立的驱动电路。
- **驱动逻辑**：MCU 的控制引脚（如 `K1_CTRL`）通过一个限流电阻连接到一个 **NPN 型三极管**（或 N-MOSFET）的基极。三极管的发射极接地，集电极连接到继电器线圈的一端。线圈的另一端连接到 5V 电源（`RL_5V`）。
- **工作方式**：当 MCU 对应引脚输出高电平时，三极管导通，形成从 `RL_5V` -> 继电器线圈 -> 三极管集电极 -> 发射极 -> GND 的电流回路，继电器线圈通电吸合。
- **续流二极管**：每个继电器线圈两端都并联一个**续流二极管**（Flyback Diode）。该二极管在三极管截止、线圈断电时为产生的感应电动势提供一个释放回路，从而保护驱动三极管不被高压击穿。

#### 3.3 负载接口与模式切换
- **接线端子**：提供 4 组 2-Pin 的绿色接线端子，分别对应四路继电器的 `COM` 和 `NO` 接口。
- **工作模式切换**：每个继电器通道旁设有一组 **跳线帽接口（J1-J4）**，用于切换有源/无源工作模式。
    - **无源模式 (Passive Mode)**：默认状态，不安装跳线帽。此时 `COM` 和 `NO` 端子是完全电气隔离的，相当于一个干接点开关，用于控制外部独立的负载回路。
    - **有源模式 (Active Mode)**：插上跳线帽。跳线帽会将外部输入电压 `VIN` 直接连接到该路继电器的 `COM` 端子。此时，当继电器吸合，`NO` 端子将输出 `VIN` 电压，可直接驱动负载。

### 4. 通讯接口
- **I2C 通讯**：模块通过 I2C 协议与 M5 主机进行通讯，其 I2C 从设备地址固定为 **0x26**。
- **信号连接**：
    - MCU 的 I2C 数据引脚（SDA）连接到 M5-Bus 的 **PIN17**。
    - MCU 的 I2C 时钟引脚（SCL）连接到 M5-Bus 的 **PIN18**。
- **上拉电阻**：SDA 和 SCL 信号线上均接有上拉电阻，连接到 **3.3V (`VCC_3V3`)** 电源，以满足 I2C 总线规范。

### 5. M5-Bus 接口
模块通过标准的 M5-Bus 接口与 M5 主机连接，引脚定义如下：
- **HPWR**：直接连接到外部直流输入的 `VIN` (5-24V)。
- **5V**：由模块板载 DC-DC 电路生成，向 M5 主机提供 5V 电源。
- **3V3**：与 M5 主机的 3.3V 电源轨相连，但模块自身不从此引脚取电。
- **GND**：系统公共地。
- **PIN17 (SDA)**：I2C 数据线。
- **PIN18 (SCL)**：I2C 时钟线。

### 6. MCU 编程接口
- 为便于固件烧录和调试，STM32 MCU 的 **SWD (Serial Wire Debug)** 接口引脚（**SWDIO**、**SWCLK**）以及复位引脚（**NRST**）被引出到 PCB 上的测试点或专用烧录座。

---

## 补充信息

是的，在对 M5Stack Module13.2 4Relay v1.1 的典型设计进行分析后，可以补充以下几个关键技术点，使描述更加完整：

### 7. 负载路径隔离设计 (Load Path Isolation Design)
- **电气隔离**: 模块的核心安全设计在于控制电路与负载电路之间的电气隔离。这种隔离是通过继电器本身的物理结构实现的。MCU 及其驱动电路（低压控制侧）与继电器的 `COM` 和 `NO` 触点（高压/大电流负载侧）之间没有直接的电气连接，确保了 M5 主机和控制系统的安全。
- **PCB 布局考量**: 在印刷电路板（PCB）设计上，为了增强隔离效果和安全性，通常会采取以下措施：
    - **安全间距**: 负载侧（连接到绿色接线端子）的走线与控制侧的低压数字电路走线之间保持足够大的物理距离。
    - **隔离槽/开槽 (Milling Slot)**: 在 PCB 上，继电器高压引脚和低压引脚之间会物理切割出一条或多条槽，这能显著增加沿 PCB 表面的爬电距离（Creepage Distance），有效防止在高湿或多尘环境下因表面导电而引发的短路或电弧，从而提升了模块在切换较高电压负载时的可靠性和安全性。

### 8. 指示灯电路 (Indicator Circuit)
- **继电器状态指示灯**: 每个继电器通道通常都配有一个独立的 LED 状态指示灯（通常为蓝色或白色）。该 LED 与对应继电器的驱动信号联动。当 MCU 发出指令激活某路继电器时，相应的 LED 会点亮，为用户提供直观的继电器工作状态反馈。
- **电源指示灯**: 模块上通常设有一个电源指示灯（通常为红色）。该 LED 连接到模块内部的 3.3V 或 5V 电源轨。一旦模块通过 M5-Bus 或外部 DC 接口上电，该指示灯就会亮起，表明模块已正常供电。

### 9. MCU 系统补充
- **时钟源**: STM32G030F6 MCU 极有可能使用其内部的高速RC振荡器（HSI）作为系统时钟源。对于继电器控制和 I2C 通信这类应用，内部时钟的精度已完全足够，并且可以省去外部晶体振荡器，从而简化电路设计并降低成本。
- **复位电路**: MCU 的 `NRST` (复位) 引脚通常连接到一个由上拉电阻和下拉电容组成的简单 RC 复位电路，以确保上电时可靠复位。该引脚也可能引出到编程接口，用于外部调试器控制。

### 10. 信号与电源完整性
- **去耦电容**: 在 MCU 的 `VDD` 电源引脚、LDO 稳压器的输入和输出端，以及 DC-DC 转换器的关键节点附近，都放置了不同容值的去耦电容（例如 100nF、10uF）。这些电容用于滤除电源噪声、稳定电压，确保数字芯片和模拟电路的稳定运行。
- **I2C 上拉电阻**: 原理图中明确包含了 I2C 总线（SDA, SCL）到 `VCC_3V3` 的上拉电阻。这是 I2C 协议所必需的，它们在总线空闲时将信号线拉至高电平。

---

*该文档由 AI 自动生成，生成时间: 2025-11-17 22:16:52*
