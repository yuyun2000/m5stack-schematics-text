# Hat 8Servos v1.1 原理图描述

---

## 原理图分析

好的，这是对 Hat 8Servos v1.1 原理图的技术描述。

### 主要芯片及其功能
- **核心控制器 (U1)**: 型号为 `STM32F030F4P6`。该微控制器是整个模块的控制核心，主要负责以下功能：
    - **PWM 信号生成**: 通过内部的定时器资源，生成 8 路独立的 PWM 信号，用于精确控制舵机的角度。
    - **I2C 通信**: 作为 I2C 从设备，通过 I2C 接口与上层主控（如 M5StickC）进行通信，接收指令并反馈状态。I2C 地址固定为 `0x36`。
    - **电源管理**: 控制舵机供电电路的开关。

### 电路设计思想与连接关系
该模块的设计思想是作为一个 I2C 扩展设备，将主控制器的 I2C 指令转换为 8 路舵机所需的 PWM 信号，从而分担主控的 PWM 生成和引脚资源压力。
- **控制与驱动分离**: MCU (`U1`) 的逻辑电路使用来自 M5Stick 的 `3.3V` 电源，而舵机的大电流驱动则直接由独立的锂电池供电。这种设计将逻辑部分与功率部分隔离，减少了舵机工作时对 MCU 的电源干扰。
- **软件控制电源**: 通过 MCU 控制一个 MOS 管，实现了对所有 8 路舵机电源 (`V_SERVO`) 的统一开关管理。这允许上层主控通过 I2C 命令来开启或关闭舵机电源，有助于降低待机功耗和提高系统安全性。

### 供电与充电电路
- **电池输入**: 电路通过 `BAT` 接口连接一块单节锂电池（如 16340 或 18350）。电池电压经 `BAT_IN` 网络输入。
- **反接保护**: 一颗 P-Channel MOS 管 `Q2` (TPC8107) 串联在电池正极输入通路上，其栅极接地。当电池正确连接时，`Q2` 的 Vgs 为负，MOS 管导通；当电池反接时，Vgs 为正或零，MOS 管截止，从而保护后端电路免受损坏。
- **舵机供电**: 经过反接保护后的电池电压 `V_BAT` 连接到 P-Channel MOS 管 `Q1` (TPC8107) 的源极。`Q1` 的漏极输出 `V_SERVO` 电压，专门用于为 8 个舵机供电。
- **MCU 供电**: 主控芯片 `U1` (STM32F030F4P6) 的 `VDD` 引脚直接由 `3.3V` 供电，该 `3.3V` 电源由上层 M5Stick 通过 HAT 接口提供，模块本身不包含为 MCU 供电的稳压电路。

### 信号路径
- **I2C 信号路径**: 来自 M5Stick 的 `SCL` 和 `SDA` 信号通过 HAT 接口分别连接到 `U1` 的 `PA9` 和 `PA10` 引脚。总线上有两颗 4.7kΩ 的上拉电阻 `R3` 和 `R4`，将信号线拉至 `3.3V`。
- **PWM 信号路径**: `U1` 的 8 个 GPIO 引脚被配置为 PWM 输出，直接连接到 8 个舵机接口的信号引脚。具体分配如下：
    - `PWM1` -> `PA4` -> `J1`
    - `PWM2` -> `PA5` -> `J2`
    - `PWM3` -> `PA6` -> `J3`
    - `PWM4` -> `PA7` -> `J4`
    - `PWM5` -> `PB1` -> `J5`
    - `PWM6` -> `PF0` -> `J6`
    - `PWM7` -> `PF1` -> `J7`
    - `PWM8` -> `PA0` -> `J8`
- **电源控制信号路径**: `U1` 的 `PA1` 引脚输出 `MOS_CTL` 信号，用于控制 MOS 管 `Q1` 的栅极，从而控制 `V_SERVO` 电源的通断。

### 外设模块与逻辑电路
- **舵机接口 (J1-J8)**: 提供 8 组标准的 3-Pin 舵机接口，每组接口包含 `GND`、`V_SERVO`（舵机电源）和 `PWM` 信号。
- **舵机电源控制电路**: 由 P-Channel MOS 管 `Q1`、MCU 控制引脚 `PA1` (`MOS_CTL`) 以及一个 10kΩ 的上拉电阻 `R2` 组成。当 `MOS_CTL` 输出低电平时，`Q1` 导通，向舵机提供 `V_SERVO` 电源。当 `MOS_CTL` 输出高电平或处于高阻态时，`R2` 将 `Q1` 栅极上拉至 `V_BAT`，使其截止，从而切断舵机电源。

### 串口与通讯芯片
- **通信接口**: 采用 I2C 总线进行通信，通过 HAT 接口与 M5Stick 连接。
    - `SCL`: 时钟线，连接到 `U1` 的 `PA9`。
    - `SDA`: 数据线，连接到 `U1` 的 `PA10`。
- **通信芯片**: `STM32F030F4P6` 自身集成了 I2C 通信外设，作为从设备响应主机的读写操作。

### 电平转换
该电路中没有独立的电平转换芯片。由于 `STM32F030F4P6` 和 M5Stick 的通信部分均工作在 `3.3V` 电压域（由 M5Stick 提供），因此 I2C 通信不需要进行电平转换。

---

## 补充信息

好的，这里是对 Hat 8Servos v1.1 原理图的补充技术细节：

### 补充细节

#### 微控制器支持电路 (MCU Support Circuitry)
- **电源去耦 (Power Decoupling)**: 围绕主控 `U1` (STM32F030F4P6) 配置了多颗去耦电容，以确保其稳定工作。
  - `C1` (10uF) 和 `C2` (100nF) 并联在 `VDD` 和 `GND` 之间，用于主电源的滤波和去耦。
  - `C3` (100nF) 连接在 `VDDA` (模拟电源) 和 `GND` 之间，为 MCU 内部的 ADC 等模拟模块提供干净的电源。
  - `C4` (1uF) 连接在 `VCAP` 引脚和 `GND` 之间，这是 STM32 内部电压调节器所需的外部电容。
- **复位电路 (Reset Circuit)**: MCU 的 `NRST` 引脚通过一个 10kΩ 的电阻 `R1` 上拉至 `3.3V`，并并联一个 100nF 的电容 `C5` 到地。这是一个标准的 RC 复位电路，确保在上电时 MCU 可靠复位。
- **启动模式配置 (Boot Mode Configuration)**: `BOOT0` 引脚通过一个 10kΩ 的电阻 `R5` 下拉至地。这使得 MCU 在复位后默认从内部 Flash 存储器启动，执行预烧录的固件。
- **调试接口 (Debug Interface)**: 电路板上预留了 SWD (Serial Wire Debug) 调试接口，包括 `SWDIO` (`PA13`) 和 `SWCLK` (`PA14`) 两个信号，用于固件的烧录和在线调试。在最终产品中，这些引脚通常不与外部连接器相连。

#### 电源滤波电路 (Power Filtering Circuitry)
- **电池输入滤波**: 在电池输入端 `BAT_IN` 和地之间，连接了一个 10uF 的电容 `C6`，用于滤除电池输入端的电压波动和噪声。
- **舵机电源滤波**: 在为舵机供电的 `V_SERVO` 电源轨上，并联了两个电容：
  - `C7` (100uF): 一个大容量电解电容，用作储能和低频滤波，为舵机启动或快速运动时产生的大电流脉冲提供瞬时能量。
  - `C8` (100nF): 一个陶瓷电容，用于高频去耦，滤除电源上的高频噪声。

#### HAT 接口连接
模块通过 HAT 接口与 M5Stick 主控连接，具体使用的引脚包括：
- `GND`: 电路地。
- `VIN` / `3.3V`: `3.3V` 为 MCU (`U1`) 提供逻辑电源，同时为 I2C 上拉电阻提供参考电平。`VIN` 引脚在此模块中未被使用。
- `G26`: 连接到 I2C 的 `SCL` 信号线。
- `G0`: 连接到 I2C 的 `SDA` 信号线。

---

*该文档由 AI 自动生成，生成时间: 2025-11-17 22:04:10*
