# Unit Roller485 原理图描述

---

## 原理图分析

好的，以下是 Unit Roller485 的原理图技术描述。

### **1. 主控单元**

*   **MCU 型号**：STM32G431CBU6。
*   **功能**：作为系统的核心控制器，负责执行三相无刷电机的磁场定向控制（FOC）算法、处理来自磁编码器的位置反馈数据、管理 RS485 和 I2C 通讯协议栈、驱动 OLED 显示屏和 RGB LED，以及响应用户按键输入。

### **2. 电机驱动与反馈控制系统**

*   **电路设计思想**：采用 FOC（Field-Oriented Control）闭环控制方案，通过 MCU、电机驱动芯片、无刷电机及磁编码器构成一个完整的高精度伺服系统，实现电流、速度和位置的三环控制。
*   **电机驱动芯片**：DRV8311HRRWR。该芯片接收来自 MCU 的三相 PWM 控制信号，内部集成 MOSFET 驱动器，直接驱动 D3504 无刷电机的三相绕组（U, V, W）。
*   **电流采样**：DRV8311HRRWR 内置电流采样放大器，将电机相电流转换为电压信号，并从 SOA、SOB、SOC 引脚输出。这些信号连接至 MCU 的 ADC（模数转换器）输入引脚，为 FOC 算法提供实时电流反馈。
*   **位置传感**：采用 TLI5012BE1000 磁性角度编码器，安装于电机尾部，用于检测电机的绝对旋转角度。
    *   **信号路径**：编码器通过 SPI 总线与主控 MCU 连接。MCU 作为 SPI 主机，通过读写编码器获取高精度的转子位置数据，为 FOC 解算和位置闭环控制提供依据。

### **3. 电源管理系统**

*   **外部供电**：
    *   **PWR485 接口**：接受 DC 6V–16V 的宽电压输入，作为整个系统的主要电源。此电压直接供给电机驱动芯片 DRV8311HRRWR 的 VM 引脚，用于驱动电机。
    *   **Grove 接口**：板载 Grove 接口的 5V 引脚可作为备用电源输入。
*   **内部稳压电路**：
    *   外部输入的 6V–16V 电压经过板载的 DC-DC 降压转换器，稳压至 5V，为系统内的逻辑电路和部分外设供电。
    *   5V 电压再通过一个 LDO（低压差线性稳压器）转换为 3.3V，专门供给主控 MCU STM32G431CBU6 及其他 3.3V 逻辑电平的芯片。
*   **集电环与 Grove 供电**：
    *   系统包含一个电滑环（Slip Ring）结构，允许电机旋转部分 360° 无限位旋转。
    *   主板侧的 Grove 接口（5V, GND, SDA, SCL）信号线通过电滑环连接至旋转端的 Grove 接口。
    *   旋转端的 Grove 接口可对外提供 5V/300mA 的供电能力，其电源来自于主板通过电滑环传输过来的 5V 电源。

### **4. 通讯接口**

*   **RS485 通讯**：
    *   使用一颗 RS485 收发器芯片实现差分信号的收发。
    *   **MCU 连接**：MCU 的 `PC10` (TX) 连接到收发器的 `DI` (Driver Input)，`PC11` (RX) 连接到 `RO` (Receiver Output)。`PB4` 用作方向控制引脚，连接到收发器的 `DE/RE` 使能端，用于切换发送和接收模式。
    *   **外部接口**：收发器的 `A`、`B` 差分信号线连接至 PWR485 接口。
*   **I2C 通讯**：
    *   **MCU 连接**：MCU 的 `PB7` (SDA) 和 `PA15` (SCL) 引脚作为 I2C 总线。总线上接有上拉电阻。
    *   **设备地址**：该 I2C 接口的从机地址固定为 `0x64`。
    *   **外部接口**：I2C 信号线连接至板载的 Grove 接口，用于与其他 I2C 设备通信。

### **5. 外设模块与人机交互**

*   **OLED 显示屏**：
    *   一块 0.66 寸 OLED 屏幕，通过 SPI 接口与 MCU 连接。
    *   **信号路径**：MCU 的 `PB15` (MOSI)、`PB13` (SCK)、`PB14` (D/C)、`PB10` (RST)、`PB12` (CS) 分别连接至 OLED 对应引脚，实现高速数据和指令传输。
*   **RGB LED 指示灯**：
    *   板载 2 颗 WS2812-2020 型可编程 RGB LED。
    *   **控制逻辑**：两颗 LED 串联，由 MCU 的 `PB5` 引脚发送单线数据信号进行控制，可独立设置每颗 LED 的颜色和亮度。
*   **用户按键**：
    *   一个物理按键 `SYS_SW`，连接至 MCU 的 `PC6` 引脚。该引脚配置为输入模式，并带有外部上拉或内部上拉电阻，按下时引脚电平被拉低，用于用户输入或功能切换。

### **6. 调试接口**

*   **接口类型**：SWD (Serial Wire Debug)。
*   **引脚布局**：原理图上引出了 MCU 的 SWDIO、SWCLK 和 SWO 引脚至专用的调试焊盘。此接口用于固件的烧录、在线调试和代码追踪，方便开发者进行底层开发与故障排查。

---

## 补充信息

根据您提供的硬件信息，以下是对原理图的补充性技术描述，旨在深化对各模块间关系的理解。

### **7. MCU 核心资源分配**

MCU（STM32G431CBU6）作为控制中枢，其内部外设根据功能需求被精确分配：

*   **高级控制定时器 (Advanced-Control Timer)**：用于生成三路互补的 PWM 信号，精确控制 DRV8311HRRWR 内部的 H 桥，以驱动三相无刷电机。这是实现 FOC 算法的基础。
*   **ADC (模数转换器)**：连接至 DRV8311 的电流采样输出引脚（SOA, SOB, SOC），高速、同步地采集三相电流反馈信号，为 FOC 的电流环提供实时数据。
*   **SPI (串行外设接口)**：
    *   一路 SPI 用于与 TLI5012BE1000 磁编码器通信，以高频率读取转子绝对位置，用于 FOC 的角度解算和位置环控制。
    *   另一路 SPI 用于驱动 0.66 寸 OLED 显示屏，负责刷新屏幕内容。
*   **UART/USART (通用同步/异步收发器)**：配置为与 RS485 收发器连接，实现半双工串行通信。TX 引脚（PC10）发送数据，RX 引脚（PC11）接收数据。
*   **I2C (内部集成电路总线)**：用于通过 Grove 接口与外部 I2C 从设备通信，总线地址为 0x64。
*   **GPIO (通用输入/输出)**：
    *   输出模式：用于控制 RS485 收发器的方向使能（PB4）、OLED 的片选/复位/数据指令选择（PB12, PB10, PB14）以及驱动 WS2812 RGB LED 的数据线（PB5）。
    *   输入模式：用于检测用户按键（PC6）的状态。

### **8. 核心控制回路信号流**

伺服系统的闭环控制形成了清晰的信号流：

1.  **指令与反馈**：MCU 接收外部（如 RS485）或内部预设的目标位置/速度指令。
2.  **位置/速度环**：MCU 通过 SPI 读取 TLI5012 编码器的当前位置，与目标值比较，计算出速度误差或位置误差，PID 控制器输出目标电流（Iq, Id）。
3.  **电流环**：MCU 的 FOC 算法根据当前转子位置和目标电流，计算出需要施加的三相电压矢量。
4.  **PWM 生成**：MCU 的高级定时器根据电压矢量生成对应的三相 PWM 信号。
5.  **驱动与执行**：PWM 信号输入 DRV8311，该芯片驱动无刷电机转动。
6.  **电流反馈**：DRV8311 同时将相电流反馈给 MCU 的 ADC，MCU 将实际电流与目标电流比较，实时调整 PWM 占空比，形成电流闭环。
7.  **循环**：以上步骤以极高的频率（通常为数十 kHz）循环执行，确保电机响应的快速性和稳定性。

### **9. 电源路径与分布**

*   **高压驱动电源**：外部输入的 6V-16V 电压绕过逻辑稳压电路，直接供给 DRV8311 的 `VM` 引脚，为电机提供充足的驱动能量。输入端通常包含大容量电解电容用于滤波和稳定电压。
*   **逻辑电源分支**：同一 6V-16V 输入也送至板载 DC-DC 降压稳压器，产生 5V 系统电压。
*   **5V 电源域**：由 DC-DC 输出的 5V 电源主要供给：
    *   LDO 稳压器的输入端。
    *   通过电滑环为旋转端的 Grove 接口供电。
*   **3.3V 电源域**：5V 电压经过 LDO 线性稳压器后，产生稳定的 3.3V 电压，专门供给对电源噪声敏感的数字逻辑部分，包括 STM32G431 MCU 本体、TLI5012 编码器以及 RS485 收发器的逻辑侧。

### **10. 结构与电气连接的关键：电滑环**

电滑环是实现 360° 连续旋转功能的核心部件。它在物理结构上分离了固定底座和旋转顶盖，但在电气上保持了以下信号和电源的连续性：
*   **电源**：将主板产生的 5V 和 GND 传输到旋转端的 Grove 接口。
*   **数据**：将主板 MCU 的 I2C 总线（SCL, SDA）传输到旋转端的 Grove 接口。

这一设计使得安装在旋转端的 Grove 模块（如传感器、执行器）可以在电机旋转时保持正常工作和通信，极大地扩展了应用场景。

---

*该文档由 AI 自动生成，生成时间: 2025-11-18 02:57:13*
