# StamPLC 原理图描述

---

## 原理图分析

好的，以下是基于 StamPLC (SKU: K141) 原理图的详细技术描述。

### **1. 主控单元 (Main Control Unit)**

- **核心模组**: 采用 M5Stack Stamp-S3A 模组，其核心 SoC 为乐鑫 ESP32-S3FN8。
- **关键管脚连接**:
    - **RS485 通讯**:
        - `G0`: 连接至 RS485 收发器 SIT3088EEUA (U3) 的 `DI` (数据输入) 引脚，用作 `RS485_TXD`。该引脚同时连接至 BOOT 按键。
        - `G39`: 连接至 U3 的 `RO` (数据输出) 引脚，用作 `RS485_RXD`。
        - `G46`: 连接至 U3 的 `DE/RE` (驱动/接收使能) 引脚，用作 `RS485_DIR`。
    - **CAN 通讯**:
        - `G42`: 连接至 CAN 收发器 SIT1044QTK (U15) 的 `TXD` 引脚，用作 `CAN_TXD`。
        - `G43`: 连接至 U15 的 `RXD` 引脚，用作 `CAN_RXD`。
    - **I2C 总线**:
        - `G15`: `SCL` (时钟线)，连接至所有 I2C 从设备。
        - `G13`: `SDA` (数据线)，连接至所有 I2C 从设备。
        - `G14`: `INT` (中断线)，连接至 I2C I/O 扩展芯片和传感器的中断引脚。
    - **SPI 总线**:
        - `G7`: `SCK` (时钟线)，共用于 LCD 显示屏和 MicroSD 卡槽。
        - `G8`: `MOSI` (主出从入)，共用于 LCD 显示屏和 MicroSD 卡槽。
        - `G9`: `MISO` (主入从出)，连接至 MicroSD 卡槽。
    - **外设控制**:
        - `G12`: `LCD_CS` (片选)，用于 LCD 显示屏。
        - `G10`: `SD_CS` (片选)，用于 MicroSD 卡槽。
        - `G6`: `LCD_DC` (数据/命令)，用于 LCD 显示屏。
        - `G3`: `RST` (复位)，共用于 LCD 和 I/O 扩展芯片 PI4IOE5V6408 (U12)、AW9523B (U4) 的复位。
        - `G44`: `BUZZER_PWM`，通过三极管 Q12 控制蜂鸣器。
    - **GPIO 端口**:
        - `G1`, `G2`: 连接至 PORT.A (HY2.0-4P) 接口。
        - `G4`, `G5`: 连接至 PORT.C (HY2.0-4P) 接口。
        - `G40`, `G41`: 连接至 GPIO.EXT 扩展接口。

### **2. 电源系统 (Power Supply System)**

- **外部供电**: 通过 DC5521 母座 (J12) 接入，支持 6V 至 36V 宽电压直流输入。输入端包含 SS56 肖特基二极管 (D6) 用于防反接保护，以及自恢复保险丝 (F1) 用于过流保护。
- **内部稳压电路**:
    - **5V 电源域**: 外部 `DC_IN` 经同步降压转换器 SY8303 (U16) 稳压至 `5V_MAIN`。该 5V 电源为 CAN/RS485 收发器、继电器驱动电路、蜂鸣器、PORT A/C 接口及 3.3V LDO 供电。
    - **3.3V 电源域**: `5V_MAIN` 经低压差线性稳压器 (LDO) SGM2212-3.3 (U1) 转换为 `3.3V`。该 3.3V 电源为 Stamp-S3A 主控、LCD 模组、MicroSD 卡槽、I2C 外设（传感器、I/O 扩展芯片）等核心数字电路供电。
- **供电直通**: PWR-CAN (J1, XT30) 和 PWR-485 (J2, HT3.96) 接口的电源引脚 (`DC_IN+`, `DC_IN-`) 直接与主 `DC_IN` 输入并联（经过保险丝 F1），实现外部电源的直通，方便为总线上的其他设备供电。

### **3. 通信接口 (Communication Interfaces)**

- **PWR-CAN 接口**:
    - **连接器**: XT30 (2+2) PW-M (J1)。
    - **收发器**: SIT1044QTK (U15)，将 ESP32-S3 的逻辑电平 `CAN_TXD` (G42) 和 `CAN_RXD` (G43) 转换为差分的 CAN_H 和 CAN_L 信号。
    - **供电**: U15 由 `5V_MAIN` 供电。
- **PWR-485 接口**:
    - **连接器**: HT3.96-4P (J2)。
    - **收发器**: SIT3088EEUA (U3)，将 ESP32-S3 的 `RS485_TXD` (G0) 和 `RS485_RXD` (G39) 转换为差分的 485_A 和 485_B 信号。
    - **方向控制**: `RS485_DIR` (G46) 控制 U3 的发送/接收模式。
    - **供电**: U3 由 `5V_MAIN` 供电。

### **4. 数字输入/输出 (Digital Input/Output)**

- **8路光耦隔离输入**:
    - **隔离器件**: 采用 2 颗 EL3H4 四通道光电耦合器 (`U6`, `U7`, `U8`, `U9`，实际为两颗四通道器件，原理图中分成了四颗双通道表示)。输入端与主电路地 (`GND`) 完全电气隔离。
    - **输入接口**: J5 和 J6，用户需从外部为输入端提供电源 (`PWR_IN+`)。
    - **控制芯片**: 输入信号经光耦隔离后，由 I2C I/O 扩展芯片 **AW9523B** (U4, I2C地址 `0x59`) 读取。AW9523B 的 `P0_4~P0_7` 和 `P1_4~P1_7` 管脚分别连接到 8 路光耦的输出端。
- **4路继电器输出**:
    - **输出接口**: J7 和 J8，提供常开 (NO) 和常闭 (NC) 触点，最大支持 5A AC/DC 负载。输出触点与主电路完全电气隔离。
    - **驱动逻辑**: AW9523B (U4) 的 `P0_0~P0_3` 管脚输出控制信号。
    - **驱动电路**: 控制信号送至 ULN2003A 达林顿管阵列 (U5)，由 U5 驱动 HF32F-G 型继电器 (`RL1`~`RL4`) 的线圈。继电器线圈由 `5V_MAIN` 供电，并配有续流二极管。

### **5. I/O扩展与控制逻辑 (I/O Expansion and Control Logic)**

- **芯片**: PI4IOE5V6408 (U12, I2C 地址 `0x43`)，8位 I/O 扩展器。
- **功能**:
    - **RGB LED 控制**: `P4` (B), `P5` (G), `P6` (R) 通过三极管驱动 RGB LED (LED1)。
    - **按键输入**: `P0` (KEY_C), `P1` (KEY_B), `P2` (KEY_A) 用于读取三个用户按键的状态。
    - **LCD 背光控制**: `P7` 通过三极管 Q11 控制 LCD 的背光 (`LCD_BLK`)。

### **6. 显示与存储 (Display and Storage)**

- **显示屏**: 1.14英寸彩色TFT LCD，驱动芯片为 ST7789v2。通过 SPI 总线与主控连接。
    - **连接**: `MOSI` (G8), `SCK` (G7), `LCD_DC` (G6, RS), `LCD_CS` (G12), `LCD_RST` (G3)。
- **MicroSD 卡槽**: 标准 MicroSD 卡槽 (J11)，通过 SPI 总线与主控连接。
    - **连接**: `MOSI` (G8), `MISO` (G9), `SCK` (G7), `SD_CS` (G10)。
- **总线共享**: LCD 和 MicroSD 卡槽共享 `SCK` 和 `MOSI` 信号线，通过各自独立的片选信号 (`LCD_CS`, `SD_CS`) 进行分时复用。

### **7. 板载传感器与RTC (On-board Sensors and RTC)**

- **总线**: 所有板载传感器和 RTC 均挂载在同一 I2C 总线 (`SCL`=G15, `SDA`=G13) 上。
- **电压/电流检测**:
    - **芯片**: INA226AIDGSR (U17, I2C 地址 `0x40`)。
    - **功能**: 通过监测 `DC_IN` 上的分压电阻 (`R1`, `R55`) 来测量输入电压；通过监测 `5V_MAIN` 路径上的 0.01Ω 采样电阻 (R4) 来测量系统电流。
- **温度检测**:
    - **芯片**: LM75BDP (U11, I2C 地址 `0x48`)。
    - **功能**: 测量电路板上的环境温度。
- **实时时钟 (RTC)**:
    - **芯片**: RX8130CE (U10, I2C 地址 `0x32`)。
    - **功能**: 提供硬件时钟功能，由 32.768kHz 晶振 (Y2) 提供时钟源。设计有备用电池接口 (BAT1)。

### **8. 扩展接口 (Expansion Interfaces)**

- **GPIO.EXT**:
    - **连接器**: 10-Pin 接口 (J4)。
    - **引出信号**: `G40`, `G41`, 以及共享的 `MOSI`(G8), `MISO`(G9), `SCK`(G7), `EXT_CS`(G11), `SCL`(G15), `SDA`(G13), `INT`(G14), `RST`(G3)。同时提供 `3.3V` 和 `GND`。
- **PORT.A**:
    - **连接器**: HY2.0-4P (J9)。
    - **引出信号**: `GND`, `5V`, `G2`, `G1`。
- **PORT.C**:
    - **连接器**: HY2.0-4P (J10)。
    - **引出信号**: `GND`, `5V`, `G5`, `G4`。

### **9. 总线拓扑 (Bus Topology)**

- **I2C 总线**:
    - **主设备**: ESP32-S3 (`SCL`=G15, `SDA`=G13)。
    - **从设备**:
        - AW9523B (U4, Addr: `0x59`) - DI/DO 扩展。
        - PI4IOE5V6408 (U12, Addr: `0x43`) - LED/按键/背光控制。
        - INA226AIDGSR (U17, Addr: `0x40`) - 电压/电流传感器。
        - LM75BDP (U11, Addr: `0x48`) - 温度传感器。
        - RX8130CE (U10, Addr: `0x32`) - RTC。
        - GPIO.EXT 接口。
- **SPI 总线**:
    - **主设备**: ESP32-S3 (`SCK`=G7, `MOSI`=G8, `MISO`=G9)。
    - **从设备**:
        - LCD 显示屏 (`CS`=G12)。
        - MicroSD 卡槽 (`CS`=G10)。
        - GPIO.EXT 接口 (`CS`=G11)。

---

## 补充信息

好的，基于已提供的原理图信息，以下是进一步的补充细节和电路特性分析：

### **补充细节与电路特性**

#### **1. 用户交互电路 (User Interaction Circuits)**

- **复位 (RESET) 与启动 (BOOT) 按键**:
    - **RESET 按键 (SW4)**: 直接连接到 Stamp-S3A 模组的 `EN` (Enable) 引脚。按下该键会将 `EN` 拉低，导致 ESP32-S3 芯片复位。
    - **BOOT 按键 (SW1)**: 连接到 `G0` 引脚。在设备上电或复位时按住此键，可使 ESP32-S3 进入固件下载模式 (Download Mode)。正常运行时，该按键也可作为通用输入。

- **用户按键 (KEYA/B/C)**:
    - 按键 `SW3 (KEYA)`, `SW2 (KEYB)`, `SW1 (KEYC)` 连接到 I2C I/O 扩展器 PI4IOE5V6408 (U12) 的 `P2`, `P1`, `P0` 引脚。这些引脚内部上拉，按下按键时被拉至低电平。
    - PI4IOE5V6408 的 `INT` 引脚连接到主控的 `G14`，可配置为在按键按下时产生中断，通知主控读取按键状态，避免了持续轮询。

#### **2. 蜂鸣器驱动电路 (Buzzer Driver Circuit)**

- 蜂鸣器 (BZ1) 由一个 NPN 型三极管 Q12 以共发射极开关电路的形式驱动。
- ESP32-S3 的 `G44` 引脚输出 PWM 信号作为 Q12 的基极控制信号。
- 当 `G44` 输出高电平时，Q12 导通，`5V_MAIN` 电源通过蜂鸣器形成回路，使其发声。通过调节 PWM 的占空比和频率，可以控制蜂鸣器的音调和音量。

#### **3. 电气隔离设计 (Electrical Isolation Design)**

- **输入隔离**: 8 路数字输入通过光电耦合器 (EL3H4) 实现，将外部输入信号（最高可承受较高电压）与主控的低压数字电路完全隔离。这保护了主控免受外部电路的电气噪声、浪涌和电位差的影响。
- **输出隔离**: 4 路继电器输出通过继电器本身的物理结构（线圈与触点）实现电气隔离。ULN2003A 驱动电路与主控共享地，但继电器的负载触点 (NO, COM, NC) 与主电路板完全分离，可安全地开关高电压或大电流的外部负载。

#### **4. 电源域划分与供电路径 (Power Domain Division and Supply Path)**

- **主电源域 (`DC_IN`, 6-36V)**: 从 DC5521 接口输入，经过防反接和保险丝保护后，直接为降压转换器供电，并直通至 PWR-CAN 和 PWR-485 接口。
- **5V 电源域 (`5V_MAIN`)**: 由 SY8303 从 `DC_IN` 降压产生。该电源域主要为 **功率型** 和 **模拟型** 部件供电，包括：
    - 继电器线圈驱动 (ULN2003A)
    - CAN/RS485 收发器
    - 蜂鸣器
    - PORT A/C 接口的 5V 输出
    - 为下一级 3.3V LDO 供电
- **3.3V 电源域 (`3.3V`)**: 由 SGM2212-3.3 从 `5V_MAIN` 降压产生。该电源域主要为 **核心数字逻辑** 和 **敏感** 部件供电，包括：
    - Stamp-S3A 主控模组
    - LCD 显示屏
    - MicroSD 卡槽
    - 所有 I2C 设备（AW9523B, PI4IOE5V6408, INA226, LM75, RX8130CE）

#### **5. 中断处理逻辑 (Interrupt Handling Logic)**

- 共享中断线 `G14` (`INT`) 是一个重要的设计特点。它将多个 I2C 外设（AW9523B, PI4IOE5V6408 等）的中断输出引脚连接到 ESP32-S3 的同一个 GPIO。
- 当任何一个外设需要引起主控注意时（例如输入状态变化、按键按下），它会拉低 `G14`。主控检测到 `G14` 的下降沿后，再通过 I2C 总线轮询各个设备的状态寄存器，以确定中断源并进行相应处理。这种设计节省了主控的 GPIO 资源。

---

*该文档由 AI 自动生成，生成时间: 2025-11-17 21:16:29*
