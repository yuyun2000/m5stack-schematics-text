# Stamp Timer Power 原理图描述

---

## 原理图分析

好的，遵从您的指示，以下是基于 M5Stack Stamp Timer Power 原理图的详细技术描述。

---

### M5Stack Stamp Timer Power 原理图描述

#### 1. 主要芯片及其功能

*   **BM8563 (U1)**: 低功耗实时时钟/日历（RTC）芯片。通过 I2C 总线与主控通信，I2C 地址为 `0x51`。其主要功能是进行精确计时，并利用其定时器或闹钟功能产生中断信号（`INT`），用于在预设时间唤醒整个系统。该芯片直接由电池 `VBAT` 供电，以在系统主电源关闭时仍能保持计时。
*   **TP4057 (U3)**: 线性锂电池充电管理 IC。负责对单节锂电池进行完整的充电周期管理，包括预充电、恒流充电和恒压充电。其充电电流由 `PROG` 引脚外接的电阻 R6 (2kΩ) 设定，计算公式为 I = 1000V / R_prog，因此设定充电电流为 500mA。
*   **SY7065 (U2)**: 一款同步升压（Boost）转换器。用于将电池电压 `V_SYS` 升压至稳定的 5V 输出（`VOUT_5V`）。
*   **SY8089 (U4)**: 一款高效率同步降压（Buck）DC-DC 转换器。用于将电池电压 `V_SYS` 降压至稳定的 3.3V 输出（`VOUT_3V3`）。

#### 2. 供电与充电电路

*   **电源输入**:
    *   **电池输入**: 通过 `BAT` 接口连接单节锂电池，电压为 `VBAT` (典型值 3.7V)。
    *   **外部充电输入**: 通过 HY2.0-4P 连接器 (J1) 的 `VIN_5V` 引脚提供 5V 电源，专门用于给电池充电。

*   **充电电路 (TP4057)**:
    *   外部 5V (`VIN_5V`) 电源输入到 TP4057 的 `VCC` 引脚。
    *   TP4057 的 `BAT` 引脚连接到电池正极 `VBAT`，实现对电池的充电。
    *   `STDBY` (引脚 1) 和 `CHRG` (引脚 7) 分别通过限流电阻 R5 和 R4 连接到绿色 LED (LED2) 和红色 LED (LED1)，用于指示充电状态：LED1 亮表示正在充电，LED2 亮表示充电完成或未接电池。

*   **电源输出**:
    *   模块通过 STAMP 引脚提供两路主电源输出：`VOUT_5V` 和 `VOUT_3V3`。

#### 3. 电路设计思想与控制逻辑

本模块的核心设计思想是利用 RTC 实现超低功耗的定时唤醒与休眠。电源控制逻辑由一组 MOSFET 开关和控制信号实现。

*   **主电源开关**:
    *   电路使用一个 P-Channel MOSFET (Q1) 作为主电源的高侧开关。其源极（Source）连接电池 `VBAT`，漏极（Drain）输出为系统内部主供电 `V_SYS`。当 Q1 导通时，电池电力供给后续的升压和降压电路；当 Q1 截止时，系统主电源被切断，实现低功耗休眠。

*   **开关控制逻辑**:
    *   Q1 的导通由一个 N-Channel MOSFET (Q2) 控制。当 Q2 的栅极（Gate）为高电平时，Q2 导通，将 Q1 的栅极拉至低电平，从而使 P-MOSFET Q1 导通。反之，当 Q2 栅极为低电平时，Q2 截止，Q1 的栅极被上拉电阻拉高至 `VBAT`，导致 Q1 截止。

*   **唤醒逻辑 (使 Q2 导通)**:
    1.  **RTC 定时唤醒**: BM8563 的 `INT` 引脚配置为低电平有效中断输出。当定时器到达预设时间，`INT` 引脚输出低电平，通过二极管 D2 将 Q2 的栅极拉低，从而触发系统上电。
    2.  **手动/外部唤醒**: STAMP 接口的 `WAKE_UP` (G36) 引脚被外部拉低时，同样通过 D2 使 Q2 导通，实现外部信号唤醒。
    3.  **按键唤醒**: 板载按键 S1 (`POWER_EN`) 被按下时，直接将 Q2 的栅极接地，实现手动开机。

*   **电源维持与休眠逻辑**:
    *   **维持 (Hold)**: 系统被唤醒后，主控（如 M5StampS3）必须立即通过 `HOLD` (G34) 引脚输出高电平。此高电平施加于 Q2 的栅极，使 Q2 持续导通，从而保持 Q1 的导通状态，维持系统供电 `V_SYS`。
    *   **休眠 (Sleep)**: 当主控完成任务需要进入休眠时，只需将 `HOLD` (G34) 引脚置为低电平。此时，如果 RTC 的 `INT` 信号也处于高电平（非中断状态），Q2 的栅极将变为低电平，Q2 截止，进而 Q1 截止，切断 `V_SYS` 供电，系统进入超低功耗状态。

#### 4. 信号路径与电压转换

*   **电源路径**: `VBAT` -> P-MOSFET (Q1) -> `V_SYS`。`V_SYS` 作为内部总线，同时为 5V 升压电路和 3.3V 降压电路供电。
*   **5V 升压电路 (U2, SY7065)**: 输入为 `V_SYS`，通过电感 L1 (2.2µH) 进行升压，输出稳定的 `VOUT_5V`。其使能引脚 `EN` 直接连接到 `V_SYS`，因此只要系统主电源 `V_SYS` 存在，5V 电路就工作。
*   **3.3V 降压电路 (U4, SY8089)**: 输入为 `V_SYS`，通过电感 L2 (2.2µH) 进行降压，输出稳定的 `VOUT_3V3`。其使能引脚 `EN` 也直接连接到 `V_SYS`，与 5V 电路同步工作。
*   **I2C 信号与电平**: BM8563 的 `SDA` 和 `SCL` 信号线通过上拉电阻 R1 和 R2 (均为 4.7kΩ) 上拉至 `VBAT`。这意味着 I2C 总线的逻辑高电平电压与电池电压相同（约 3.0V ~ 4.2V），而非 3.3V 或 5V。连接到此总线的主控需要能够兼容此电压范围或使用电平转换电路。

#### 5. 接口与外设模块

*   **STAMP 接口 (2.54mm 间距引脚)**:
    *   **电源**: `GND`, `BAT` (电池电压监测/输入), `5V` (输出), `3.3V` (输出)。
    *   **I2C 通信**: `G21` (SDA), `G22` (SCL)，连接至 BM8563。
    *   **控制信号**: `G34` (HOLD)，用于电源维持；`G36` (WAKE_UP)，用于外部唤醒。

*   **HY2.0-4P 接口 (J1)**:
    *   **功能**: 提供外部充电和 I2C 通信的便捷连接。
    *   **引脚定义**: `GND`, `VIN_5V` (外部 5V 充电输入), `SCL`, `SDA`。此处的 SCL/SDA 与 STAMP 接口的 G22/G21 是并联的。

*   **电池接口 (BAT)**: 一个 2-Pin 的 JST 连接器，用于连接锂电池。

*   **其他外设**:
    *   **晶振 (Y1)**: 32.768kHz 的晶振，为 BM8563 提供计时基准。
    *   **按键 (S1)**: 一个贴片按键，用于手动唤醒系统。
    *   **指示灯**: LED1 (红色) 和 LED2 (绿色)，用于指示 TP4057 的充电状态。

---

## 补充信息

是的，在对原理图进行更深入的分析后，可以补充以下技术细节：

### 补充技术细节

#### 1. 保护电路设计

*   **自恢复保险丝 (F1)**: 在电池接口 `BAT` 和主电路之间串联了一个 PPTC 自恢复保险丝 (F1)。该元件在电路发生过流时会呈高阻态，切断电流，从而保护电池和下游电路。当故障排除、电流恢复正常后，它会自动恢复到低阻态。
*   **二极管隔离 (D2)**: 在唤醒控制逻辑中，二极管 D2 (型号 SS14，为肖特基二极管) 起到了关键的隔离作用。它将 RTC 中断信号 `INT` 和外部唤醒信号 `WAKE_UP` 汇合到 N-MOSFET (Q2) 的栅极，形成了一个“或门”逻辑（任一信号为低电平即可触发唤醒）。同时，它能防止 `HOLD` 引脚的高电平（可能为3.3V）反向灌入 RTC 的 `INT` 引脚（其电平由 `VBAT` 决定）。

#### 2. 电源域与功耗管理

*   **Always-On Domain (常电域)**: BM8563 (U1) 及其外围晶振直接由 `VBAT` 供电。这构成了一个独立的、始终在线的电源域，确保即使在主系统断电的休眠状态下，RTC 也能持续计时并能在预设时间发出唤醒信号。
*   **Switched Domain (可开关域)**: 电路的主要部分，包括 5V 升压转换器 (U2) 和 3.3V 降压转换器 (U4)，均由 `V_SYS` 供电。`V_SYS` 是通过 P-MOSFET (Q1) 开关控制的。这种设计使得主控可以通过 `HOLD` 信号切断整个 `V_SYS` 域的电源，从而实现系统的深度休眠，仅保留 RTC 工作的微安级功耗。

#### 3. 控制逻辑的实现细节

*   **默认关断状态**: N-MOSFET (Q2) 的栅极通过一个 100kΩ 的上拉电阻 R7 连接到 `VBAT`。在没有唤醒信号（`INT`、`WAKE_UP`、`POWER_EN` 均为高电平或悬空）时，该电阻将 Q2 的栅极拉高，使 Q2 保持截止状态。这进一步导致主电源开关 Q1 的栅极被拉高至 `VBAT`，使 Q1 截止，确保系统在默认情况下处于断电状态。
*   **电源输出使能**: 5V 升压电路 (SY7065) 和 3.3V 降压电路 (SY8089) 的使能引脚 (`EN`) 均直接连接到 `V_SYS`。这意味着一旦主电源开关 Q1 导通，`V_SYS` 建立，这两路电源输出就会立即开始工作。它们不能被独立地通过软件关闭，其开关状态与 `V_SYS` 完全绑定。

#### 4. 接口与测量

*   **电池电压监测**: 原理图上没有为电池电压 `VBAT` 设计专用的分压电路。而是直接将 `BAT` 引脚引出至 STAMP 接口。这意味着需要由外部的主控（如 M5StampS3）通过其自身的 ADC 引脚来直接（如果 ADC 量程支持）或间接（通过外部搭建分压电路）测量电池电压。
*   **I2C 总线上拉**: I2C 总线的上拉电阻 R1 和 R2 是上拉至 `VBAT` 而非 `VOUT_3V3`。这一点非常关键，因为 `VBAT` 的电压会在 3.0V 到 4.2V 之间浮动。与该模块通信的主控制器 I/O 引脚必须能够承受并正确解析这个电压范围内的逻辑电平。

---

*该文档由 AI 自动生成，生成时间: 2025-11-17 23:35:43*
